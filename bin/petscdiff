#! /bin/sh -f
#
#  Replaces floating point numbers with XXX and then does a diff
#  
#

# parse options -- using getopts because it is so easily extensible
update=false
while getopts "u" opt
do
  case $opt in
    u ) update=true
  esac
done
shift $(( $OPTIND - 1 ))

if [ $# -lt 2 ]; then
  echo Error! Usage: petscdiff [-u]  file1 file2
  echo  "-u Updates file1 with file2 (assumes it is [old new] ordering)"
  exit 1
fi

if [ "x${RM}" = "x" ]; then RM="rm"; fi
if [ "x${SED}" = "x" ]; then SED="sed"; fi
if [ "x${DIFF}" = "x" ]; then DIFF="diff -w";
elif [ "`basename ${DIFF}`" = "petscdiff" ]; then DIFF="diff -w";
fi

if [ "x${1}" = "x-" ]; then
    file1=`mktemp -t petscdiff.XXXXXX` ;
    $(cat /dev/stdin > ${file1})
elif [ -f ${1} ]; then
    file1=${1}
else
  echo Error! file1 check failed: "${1}"
  exit 1
fi

if [ -f ${2} ]; then
    file2=${2}
else
  echo Error! file2 check failed: "${2}"
  exit 1
fi

tmpA=`mktemp -t petscdiffA.XXXXXX` ;
tmpB=`mktemp -t petscdiffB.XXXXXX` ;

${SED} "s/< [0-9][0-9]*\.*[0-9]*[eE][-+][0-9][0-9]*/XXX/g" ${file1} | ${SED} "s/[-]*[0-9][0-9]*\.*[0-9]*[eE][-+][0-9][0-9]*/XXX/g" | ${SED}  "s/[-]*[0-9][0-9]*\.[0-9]*/XXX/g" | ${SED} "s/ \*\*\*\*\*\*\*\*\* /XXX/g" > ${tmpA}

${SED} "s/< [0-9][0-9]*\.*[0-9]*[eE][-+][0-9][0-9]*/XXX/g" ${file2} | ${SED} "s/[-]*[0-9][0-9]*\.*[0-9]*[eE][-+][0-9][0-9]*/XXX/g" | ${SED}  "s/[-]*[0-9][0-9]*\.[0-9]*/XXX/g" | ${SED} "s/ \*\*\*\*\*\*\*\*\* /XXX/g" > ${tmpB}
${DIFF} ${tmpA} ${tmpB} > /dev/null
if [ $? -ne 0 ]; then
  ${DIFF}  ${file1} ${file2}
  err=1
else
  err=0
fi

${RM} -f ${tmpA} ${tmpB}
if [ "x${1}" = "x-" ]; then
  ${RM} -f ${file1}
fi

if ${update}; then
  echo "Updating $file2 --> $file1"
  mv "$file2" "$file1"
fi

exit ${err};
